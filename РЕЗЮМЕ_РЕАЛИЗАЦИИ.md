# ‚úÖ –†–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Repository Dependency Injection

## üéØ –ó–∞–¥–∞—á–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω, –≥–¥–µ **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `db` –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –≤ `__init__`** –∏ **–ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ endpoint —á–µ—Ä–µ–∑ `Depends`**.

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. üîß –û–±–Ω–æ–≤–ª–µ–Ω–∞ –±–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

**–§–∞–π–ª:** `src/repositories/base.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

- –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `db: AsyncSession`
- –í—Å–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `self.db` –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∏ `db` –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
- –£–±—Ä–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `db` –∏–∑ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤

**–î–æ:**

```python
def __init__(self, model: Type[ModelType]):
    self.model = model

async def create(self, db: AsyncSession, *, obj_in: CreateSchemaType):
    # —Ä–∞–±–æ—Ç–∞ —Å db
```

**–ü–æ—Å–ª–µ:**

```python
def __init__(self, model: Type[ModelType], db: AsyncSession):
    self.model = model
    self.db = db  # üîë –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

async def create(self, *, obj_in: CreateSchemaType):
    # —Ä–∞–±–æ—Ç–∞ —Å self.db
```

### 2. üè™ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- ‚úÖ `src/repositories/user.py` - **–ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤**
- ‚úÖ `src/repositories/survey.py` - **–ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤**
- ‚úÖ `src/repositories/question.py` - **–ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤**
- ‚úÖ `src/repositories/response.py` - **–ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤**
- ‚úÖ `src/repositories/user_data.py` - **–ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤**
- üîÑ `src/repositories/push_notification.py` - **—á–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω**

**–ü–∞—Ç—Ç–µ—Ä–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞:**

```python
class UserRepository(BaseRepository[User, UserCreate, UserUpdate]):
    def __init__(self, db: AsyncSession):
        super().__init__(User, db)  # üîë –ü–µ—Ä–µ–¥–∞–µ–º db –≤ –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å
```

### 3. ‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ dependency —Ñ—É–Ω–∫—Ü–∏–π

**–§–∞–π–ª:** `src/repositories/dependencies.py`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

```python
def get_user_repository(
    db: AsyncSession = Depends(get_async_session),
) -> UserRepository:
    return UserRepository(db)  # üîë –°–æ–∑–¥–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å db
```

### 4. üìã –°–æ–∑–¥–∞–Ω –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `src/routers/example_with_repo.py`

**–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:**

- ‚úÖ Injection —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ `Depends`
- ‚úÖ –ß–∏—Å—Ç—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –±–µ–∑ –ø—Ä—è–º–æ–π —Ä–∞–±–æ—Ç—ã —Å `db`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ü—Ä–∏–º–µ—Ä —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞:**

```python
@router.get("/users/{user_id}")
async def get_user_by_id(
    user_id: int,
    user_repo: UserRepository = Depends(get_user_repository),  # üîë DI
):
    user = await user_repo.get(user_id)  # üîë –ß–∏—Å—Ç—ã–π –∫–æ–¥
    if not user:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    return UserResponse.model_validate(user)
```

### 5. üìö –°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–§–∞–π–ª—ã:**

- ‚úÖ `REPOSITORY_DEPENDENCY_INJECTION.md` - **–ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- ‚úÖ –î–∏–∞–≥—Ä–∞–º–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏

## üî• –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚úÖ –ß–∏—Å—Ç—ã–π –∫–æ–¥ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

```python
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±
async def get_user(user_id: int, db: AsyncSession = Depends(...)):
    query = select(User).where(User.id == user_id)
    result = await db.execute(query)
    # –º–Ω–æ–≥–æ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –∫–æ–¥–∞...

# –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–±
async def get_user(user_id: int, user_repo: UserRepository = Depends(...)):
    return await user_repo.get(user_id)  # –ß–∏—Å—Ç–æ –∏ –ø—Ä–æ—Å—Ç–æ!
```

### ‚úÖ –õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –ú–æ–∫–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –∞ –Ω–µ —Å–µ—Å—Å–∏—é –ë–î
mock_repo = Mock(spec=UserRepository)
app.dependency_overrides[get_user_repository] = lambda: mock_repo
```

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

- FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç `AsyncSession`
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å–µ—Å—Å–∏—é
- –ù–µ—Ç —É—Ç–µ—á–µ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

- –û–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –ú–µ—Ç–æ–¥—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö
- –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –í –Ω–æ–≤—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö:

```python
@router.get("/users")
async def get_users(
    user_repo: UserRepository = Depends(get_user_repository),
):
    return await user_repo.get_multi()
```

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:

```python
# –ó–∞–º–µ–Ω–∏—Ç—å
session: AsyncSession = Depends(get_async_session)
# –ù–∞
user_repo: UserRepository = Depends(get_user_repository)

# –ò –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤–º–µ—Å—Ç–æ –ø—Ä—è–º—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤:

```python
class NewRepository(BaseRepository[Model, CreateSchema, UpdateSchema]):
    def __init__(self, db: AsyncSession):
        super().__init__(Model, db)

def get_new_repository(db: AsyncSession = Depends(get_async_session)):
    return NewRepository(db)
```

## üéØ –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- ‚úÖ **–ë–∞–∑–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –≥–æ—Ç–æ–≤–∞ –Ω–∞ 100%
- ‚úÖ **UserRepository** - –≥–æ—Ç–æ–≤ –Ω–∞ 100%
- ‚úÖ **–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** - –≥–æ—Ç–æ–≤—ã –Ω–∞ 100%
- üîÑ **Push Notification —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏** - –≥–æ—Ç–æ–≤—ã –Ω–∞ 70%
- ‚úÖ **Dependency —Ñ—É–Ω–∫—Ü–∏–∏** - –≥–æ—Ç–æ–≤—ã –Ω–∞ 100%
- ‚úÖ **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** - –≥–æ—Ç–æ–≤ –Ω–∞ 100%
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –≥–æ—Ç–æ–≤–∞ –Ω–∞ 100%

## üîÑ –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

1. **–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** `push_notification.py` —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
2. **–°–æ–∑–¥–∞—Ç—å dependency —Ñ—É–Ω–∫—Ü–∏–∏** –¥–ª—è –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –≤ `dependencies.py`
3. **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** –Ω–∞ –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
4. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
5. **–î–æ–±–∞–≤–∏—Ç—å type hints** –¥–ª—è –ª—É—á—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ IDE

## ‚ú® –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!** üéâ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω **Repository + Dependency Injection**, –∫–æ—Ç–æ—Ä—ã–π:

- üèóÔ∏è –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —á–∏—Å—Ç—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- üß™ –£–ø—Ä–æ—â–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- üîÑ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–¥
- üõ°Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å–∞–º–∏
- üìà –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π!
